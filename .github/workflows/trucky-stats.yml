name: Update Trucky Stats

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Trucky company JSON and write trucky.json
        env:
          TRUCKY_ACCESS_TOKEN: ${{ secrets.TRUCKY_ACCESS_TOKEN }}
        run: |
          python3 - << 'PY'
          import json, datetime, urllib.request, os

          COMPANY_ID = 43152
          token = os.environ.get("TRUCKY_ACCESS_TOKEN","").strip()
          if not token:
            raise SystemExit("Missing TRUCKY_ACCESS_TOKEN secret")

          headers = {
            "Accept": "application/json",
            "User-Agent": "BlackRavenLogisticsSite/1.0 (GitHub Actions)",
            "x-access-token": token,
          }

          url = f"https://e.truckyapp.com/api/v1/company/{COMPANY_ID}"

          req = urllib.request.Request(url, headers=headers)
          with urllib.request.urlopen(req, timeout=25) as resp:
            raw = resp.read().decode("utf-8", errors="replace")
          company = json.loads(raw)

          # ---- DEBUG: show keys (no token printed) ----
          def top_keys(obj):
            return list(obj.keys()) if isinstance(obj, dict) else []

          print("TOP KEYS:", top_keys(company))

          # Look for likely nested containers
          for k in ["stats","statistic","statistics","totals","alltime","monthly","ats","ets2","games"]:
            v = company.get(k) if isinstance(company, dict) else None
            if isinstance(v, dict):
              print(f"DICT KEYS company['{k}']:", list(v.keys()))
            elif isinstance(v, list):
              print(f"LIST LEN company['{k}']:", len(v))

          # Deep find helper
          def deep_find(obj, key_names):
            if isinstance(obj, dict):
              for k, v in obj.items():
                if k in key_names:
                  return v
                found = deep_find(v, key_names)
                if found is not None:
                  return found
            elif isinstance(obj, list):
              for item in obj:
                found = deep_find(item, key_names)
                if found is not None:
                  return found
            return None

          members = deep_find(company, {"membersCount","members_count","members","membersTotal"})
          if isinstance(members, dict) and "count" in members:
            members = members["count"]

          # Try to extract ATS monthly-like stats from within company payload
          # We prefer ATS numbers if present
          def find_game_block(root, game_key):
            # Common patterns: root["games"]["ats"], root["ats"], root["stats"]["ats"], list with game field etc.
            if isinstance(root, dict):
              if game_key in root and isinstance(root[game_key], dict):
                return root[game_key]
              games = root.get("games")
              if isinstance(games, dict) and game_key in games and isinstance(games[game_key], dict):
                return games[game_key]
              stats = root.get("stats")
              if isinstance(stats, dict):
                if game_key in stats and isinstance(stats[game_key], dict):
                  return stats[game_key]
                g = stats.get("games")
                if isinstance(g, dict) and game_key in g and isinstance(g[game_key], dict):
                  return g[game_key]
            return None

          ats = find_game_block(company, "ats")
          ets2 = find_game_block(company, "ets2")

          def pick_stats(block):
            if not isinstance(block, dict):
              return None, None, None
            # jobs
            jobs = deep_find(block, {"jobs","jobsCount","total_jobs","totalJobs"})
            # distance
            dist = deep_find(block, {"distance","total_distance","totalDistance","distance_total","total"})
            # unit
            unit = deep_find(block, {"unit","distance_unit","distanceUnit"})
            return jobs, dist, unit

          jobs, dist, unit = pick_stats(ats)
          if jobs is None and dist is None:
            jobs, dist, unit = pick_stats(company)  # last resort: anywhere

          distance_text = None
          try:
            if dist is not None:
              dist_num = float(dist)
              label = unit or "mi"
              distance_text = f"{int(dist_num):,} {label}"
          except:
            distance_text = str(dist) if dist is not None else None

          rating = deep_find(company, {"rating","score"})

          out = {
            "members": members,
            "jobs": jobs,
            "distance_text": distance_text,
            "rating": rating,
            "updated_utc": datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M"),
            "source": url
          }

          with open("trucky.json","w",encoding="utf-8") as f:
            json.dump(out,f,ensure_ascii=False,indent=2)

          print("WROTE trucky.json:", out)
          PY

      - name: Commit & push if changed
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add trucky.json
          git commit -m "chore: update Trucky stats"
          git push
