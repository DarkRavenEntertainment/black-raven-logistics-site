name: Update Trucky Stats

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Trucky stats and write trucky.json
        env:
          TRUCKY_ACCESS_TOKEN: ${{ secrets.TRUCKY_ACCESS_TOKEN }}
        run: |
          python3 - << 'PY'
          import json, datetime, urllib.request, os

          COMPANY_ID = 43152
          token = os.environ.get("TRUCKY_ACCESS_TOKEN","").strip()
          if not token:
              raise SystemExit("Missing TRUCKY_ACCESS_TOKEN secret")

          HEADERS = {
              "Accept": "application/json",
              "User-Agent": "BlackRavenLogisticsSite/1.0",
              "x-access-token": token,
          }

          def get_json(url):
              req = urllib.request.Request(url, headers=HEADERS)
              with urllib.request.urlopen(req, timeout=25) as resp:
                  raw = resp.read().decode("utf-8", errors="replace")
              return json.loads(raw)

          company_url = f"https://e.truckyapp.com/api/v1/company/{COMPANY_ID}"
          stats_url   = f"https://e.truckyapp.com/api/v1/company/{COMPANY_ID}/stats"

          company = get_json(company_url)
          stats = get_json(stats_url)

          members = company.get("members_count")

          def deep_find(obj, keys):
              if isinstance(obj, dict):
                  for k, v in obj.items():
                      if k in keys:
                          return v
                      found = deep_find(v, keys)
                      if found is not None:
                          return found
              elif isinstance(obj, list):
                  for item in obj:
                      found = deep_find(item, keys)
                      if found is not None:
                          return found
              return None

          jobs = deep_find(stats, {"jobs", "total_jobs", "jobsCount"})
          total_distance = deep_find(stats, {
              "total_distance",
              "distance",
              "totalDistance",
              "mileage",
              "total"
          })

          total_distance_text = None
          if total_distance is not None:
              try:
                  total_distance_text = f"{int(float(total_distance)):,} km"
              except:
                  total_distance_text = str(total_distance)

          on_time_percent = deep_find(stats, {
              "on_time",
              "onTime",
              "on_time_percent",
              "onTimePercent"
          })

          if isinstance(on_time_percent, float):
              on_time_percent = round(on_time_percent)

          if on_time_percent is not None:
              on_time_text = f"{on_time_percent}%"
          else:
              on_time_text = None

          out = {
              "members": members,
              "jobs": jobs,
              "total_distance": total_distance_text,
              "on_time_percent": on_time_text,
              "updated_utc": datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M"),
          }

          with open("trucky.json", "w", encoding="utf-8") as f:
              json.dump(out, f, ensure_ascii=False, indent=2)

          print("Updated trucky.json:", out)
          PY

      - name: Commit & push if changed
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add trucky.json
          git commit -m "chore: update Trucky stats"
          git push
